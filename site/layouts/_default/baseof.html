<!doctype html>

<html lang="{{.Site.Language.Lang }}">

<head>
    <meta charset="utf-8">
    <title>{{ .Site.Title }}</title>
    <meta name="viewport" content="initial-scale=1.0,maximum-scale=1.0" />
    <link href="https://fonts.googleapis.com/css?family=Titillium+Web&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    {{ block "main" . }}
    {{ end }}
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg==" crossorigin=""></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
    <script>

        /**
         * Converts a value from degrees to radians.
         *
         * @param {number} value in degrees
         * @return {number} same value converted to radians
         */
        function toRadians(degrees) {
            return degrees * Math.PI / 180;
        }

        /**
         * Computes the distance between two locations on Earth using the
         * harvesine formula.
         *
         * https://en.wikipedia.org/wiki/Haversine_formula
         *
         * @param {number} latitude of the first location
         * @param {number} longitude of the first location
         * @param {number} latitude of the second location
         * @param {number} longitude of the second location
         * @return {number} distance between the locations
         */
        function getEarthDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters

            const φ1 = toRadians(lat1);
            const φ2 = toRadians(lat2);

            const Δφ = toRadians(lat2 - lat1);
            const Δλ = toRadians(lon2 - lon1);

            // Harvesine
            const h = Math.pow(Math.sin(Δφ / 2), 2) +
                      Math.cos(φ1) * Math.cos(φ2) * 
                      Math.pow(Math.sin(Δλ/2), 2);

            // Solve for distance
            const d = 2 * R * Math.atan2(Math.sqrt(h), Math.sqrt(1 - h));
            
            return d
        }

        // Remove all paragraphs that only contain spaces (there is a bug in
        // Hugo that adds a bunch of these).
        for (const p of document.getElementsByTagName('p')){
            if (p.innerHTML.replace(/\s/g, '').length === 0){
                p.style.display = 'none';
            }
        }

        // Creaate a Leaflet button that enabled fullscreen mode
        const fullScreenControl = L.Control.extend({
            options: {
                position: 'topleft'
            },
            onAdd: function (map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                container.style.backgroundColor = 'white';
                container.style.width = '30px';
                container.style.height = '30px';
                container.innerHTML = '<a class="code4 code4-leaflet-control-fullScreen" href="#" title="Fullscreen" role="button" aria-label="Fullscreen">F</a>'
                container.onclick = function(e) {
                    e.preventDefault();
                    map.toggleFullscreen();
                }
                return container;
            }
        });

        var map = L.map('theMap').setView([51.505, -0.09], 8);
        map.addControl(new fullScreenControl());

        L.tileLayer('https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}.svg?lang=ro', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            fullScreenControl: true,
            zoomControl: false
        }).addTo(map);

        // Create Vot Diaspora marker icon
        var votDiasporaMarker = L.icon({
            iconUrl: 'marker.png',
            iconSize: [20, 39],
            iconAnchor: [10, 39]
        });

        let locations = [];
        let markers = [];

        // Get the JSON with locations
        fetch('data.json')
            .then(res => res.json())
            .then((out) => {
                locations = out.locations;
                for (const location of locations) {
                    const messageHtml =
                        '<b onclick="openInNative(' + location.coordinates[0] + ', ' + location.coordinates[1] + ')">' + location.name + '</b><br>' + location.address;
                    const marker = L.marker(location.coordinates, {
                        'title': location.name,
                        'icon': votDiasporaMarker
                    }).bindPopup(messageHtml, {
                        offset: [0, -34]
                    });
                    markers.push(marker);
                    marker.addTo(map);
                }
            }).catch(err => console.error(err));

        let theLocateButton = document.getElementById('the-locate-button');
        theLocateButton.addEventListener('mouseup', function(e) {

            // Get user's current geolocation
            navigator.geolocation.getCurrentPosition(function(position) {

                // let myLat = position.coords.latitude;
                // let myLon = position.coords.longitude;

                let myLat = 51.505;
                let myLon = -0.09;

                // Sort locations by distance to user
                locations = locations.sort(function(l1, l2) {
                    let lat1 = l1.coordinates[0];
                    let lon1 = l1.coordinates[1];
                    let lat2 = l2.coordinates[0];
                    let lon2 = l2.coordinates[1];
                    let d1 = getEarthDistance(myLat, myLon, lat1, lon1);
                    let d2 = getEarthDistance(myLat, myLon, lat2, lon2);
                    return d1 - d2;
                });

                const theLocations = document.getElementById('theLocations');
                let ht = '<ol>';
                let closestMarkers = [];
                for (let i = 0; i < 6; ++i) {
                    closestMarkers.push(L.marker(locations[i].coordinates));
                    ht += '<li onclick="goToLocation(' + i + ')"><h1>' + 
                          locations[i].name + 
                          '</h1><p>' + 
                          locations[i].address + ', ' + 
                          locations[i].country + '</p></li>';
                }
                ht += '</ol>';
                theLocations.innerHTML = ht;

                var group = new L.featureGroup(closestMarkers);
                // map.fitBounds(group.getBounds(), {
                //     'duration': 0
                // });
                map.setView([myLat, myLon], 8);
            });
        });

        function goToLocation(index) {
            map.setView(locations[index].coordinates, 10);
        }

        function openInNative(lat, lon) {
            console.log('but why ' + [lat, lon]);
            if ((navigator.platform.indexOf("iPhone") != -1) ||
                (navigator.platform.indexOf("iPad")   != -1) ||
                (navigator.platform.indexOf("iPod")   != -1) || true) {
                console.log('maps://maps.google.com/maps?daddr=' + lat + ',' + lon + '&amp;ll=');
                // window.open('maps://maps.google.com/maps?daddr=' + lat + ',' + lon + '&amp;ll=');
            }
            else {
                window.open("https://maps.google.com/maps?daddr=' + lat + ',' + lon + '&amp;ll=");
            }
        }

        let theMap = document.getElementById('theMap');
        let scrollY = 0;
        let isFullScreen = false;
     </script>

</body>

</html>
